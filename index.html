<!doctype html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI –°—Ç–∏–ª–∏—Å—Ç | Telegram Mini App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
          'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue',
          sans-serif;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        background: #0f0f0f;
        min-height: 100vh;
        padding: 20px;
        color: #e0e0e0;
      }

      #root {
        max-width: 1200px;
        margin: 0 auto;
      }

      .container {
        background: #1a1a1a;
        border-radius: 16px;
        padding: 40px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8);
      }
       @media (max-width: 600px) {
        body {
          padding: 10px;
        }
        .container {
          padding: 20px;
        }
      }

      h1 {
        text-align: center;
        color: #bb86fc;
        margin-bottom: 10px;
        font-size: 2.5em;
        font-weight: 700;
      }

      .subtitle {
        text-align: center;
        color: #888888;
        margin-bottom: 40px;
        font-size: 1em;
      }

      .upload-section {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 30px;
        margin-bottom: 30px;
      }

      @media (max-width: 768px) {
        .upload-section {
          grid-template-columns: 1fr;
        }
      }

      .step-title {
        color: #e0e0e0;
        font-size: 1.1em;
        font-weight: 600;
        margin-bottom: 15px;
        display: block;
      }

      .upload-box {
        border: 2px dashed #444444;
        border-radius: 12px;
        padding: 30px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        background: #242424;
        min-height: 150px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
      }

      .upload-box:hover {
        border-color: #666666;
        background: #2a2a2a;
        transform: translateY(-2px);
      }

      .upload-box.filled {
        border-style: solid;
        border-color: #bb86fc;
        padding: 10px;
      }

      .preview-image {
        max-width: 100%;
        max-height: 200px;
        border-radius: 8px;
        object-fit: cover;
      }

      .placeholder-text {
        color: #666666;
        font-size: 0.95em;
      }

      .prompt-section {
        margin-bottom: 30px;
      }

      .prompt-label {
        display: block;
        font-weight: 600;
        color: #e0e0e0;
        margin-bottom: 10px;
        font-size: 1em;
      }

      textarea {
        width: 100%;
        padding: 15px;
        border: 2px solid #333333;
        border-radius: 8px;
        font-family: inherit;
        font-size: 0.95em;
        resize: vertical;
        transition: border-color 0.3s ease;
        background: #242424;
        color: #e0e0e0;
        min-height: 100px;
      }

      textarea::placeholder {
        color: #666666;
      }

      textarea:focus {
        outline: none;
        border-color: #bb86fc;
      }
      
      .controls-top-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 15px;
        margin-bottom: 20px;
      }

      .buttons-container {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
        flex-wrap: wrap;
        align-items: center;
      }

      button {
        padding: 14px 30px;
        border: none;
        border-radius: 8px;
        font-size: 1em;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        -webkit-tap-highlight-color: transparent;
      }

      .btn-generate {
        flex: 1;
        min-width: 200px;
        background: linear-gradient(135deg, #bb86fc 0%, #7c4dff 100%);
        color: #000000;
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      .btn-generate:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(187, 134, 252, 0.4);
      }
      
      .btn-generate.no-credits:not(:disabled) {
        background: linear-gradient(135deg, #f7b733 0%, #fc4a1a 100%);
        color: #000;
      }

      .btn-generate:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .btn-reset {
        background: #333333;
        color: #e0e0e0;
        border: 2px solid #444444;
      }

      .btn-reset:hover {
        background: #404040;
        border-color: #666666;
      }
      
      .credits-counter {
        display: flex;
        align-items: center;
        gap: 10px;
        background-color: #242424;
        padding: 8px 16px;
        border-radius: 8px;
        font-weight: 500;
        color: #aaa;
        border: 1px solid #333;
      }
      
      .credits-counter span {
        color: #bb86fc;
        font-weight: 700;
        font-size: 1.1em;
      }
      
      .pro-badge {
        background: linear-gradient(135deg, #ffd700, #ff8c00);
        color: #000;
        padding: 3px 8px;
        border-radius: 5px;
        font-size: 0.8em;
        font-weight: bold;
        text-transform: uppercase;
      }
      
      .btn-pro {
        background: transparent;
        border: 2px solid #555;
        color: #999;
        font-size: 0.9em;
        padding: 8px 16px;
      }
      
      .btn-pro:disabled {
        cursor: not-allowed;
        opacity: 0.6;
      }

      .error-message {
        background: #3d1f1f;
        color: #ff6b6b;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        border-left: 4px solid #ff6b6b;
        word-wrap: break-word;
      }

      .loading-spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(255,255,255,.3);
        border-radius: 50%;
        border-top-color: #fff;
        animation: spin 1s ease-in-out infinite;
        margin-right: 10px;
      }

      @keyframes spin {
        to { transform: rotate(360deg); }
      }

      .history-section {
        margin-top: 40px;
        padding-top: 30px;
        border-top: 2px solid #333333;
      }

      .history-title {
        font-size: 1.5em;
        font-weight: 700;
        color: #bb86fc;
        margin-bottom: 20px;
      }

      .history-gallery {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 20px;
      }

      .history-item {
        position: relative;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.6);
        transition: transform 0.3s ease;
        border: 2px solid #333333;
        cursor: pointer;
      }

      .history-item:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 20px rgba(187, 134, 252, 0.3);
        border-color: #bb86fc;
      }

      .history-item img {
        width: 100%;
        height: 250px;
        object-fit: cover;
        display: block;
      }

      .presets-section {
        margin-bottom: 30px;
      }

      .presets-title {
        display: block;
        font-weight: 600;
        color: #e0e0e0;
        margin-bottom: 15px;
        font-size: 1em;
        text-align: center;
      }

      .presets-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        justify-content: center;
      }

      .p605
      {
        background: #2a2a2a;
        color: #e0e0e0;
        border: 1px solid #444;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 0.9em;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .preset-btn:hover {
        background: #bb86fc;
        color: #000;
        border-color: #bb86fc;
        transform: translateY(-2px);
      }
      
    </style>
  </head>
  <body>
    <div id="root">
      <div class="container">
        <h1>‚ú® AI –°—Ç–∏–ª–∏—Å—Ç</h1>
        <p class="subtitle">–í–∏—Ä—Ç—É–∞–ª—å–Ω–∞—è –ø—Ä–∏–º–µ—Ä–∫–∞ –ø—Ä–∏—á–µ—Å–æ–∫ —Å –ø–æ–º–æ—â—å—é –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–∞</p>

        <div id="error-container"></div>

        <div class="upload-section">
          <div>
            <span class="step-title">1Ô∏è‚É£ –ó–∞–≥—Ä—É–∑–∏—Ç–µ –≤–∞—à–µ —Ñ–æ—Ç–æ</span>
            <div class="upload-box" id="selfie-upload">
              <span class="placeholder-text">üì∏ –ù–∞–∂–º–∏—Ç–µ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏</span>
            </div>
            <input type="file" id="selfie-input" accept="image/*" style="display: none;" />
          </div>

          <div>
            <span class="step-title">2Ô∏è‚É£ –§–æ—Ç–æ-–ø—Ä–∏–º–µ—Ä (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</span>
            <div class="upload-box" id="reference-upload">
              <span class="placeholder-text">üñºÔ∏è –ó–∞–≥—Ä—É–∑–∏—Ç–µ –ø—Ä–∏–º–µ—Ä –ø—Ä–∏—á–µ—Å–∫–∏</span>
            </div>
            <input type="file" id="reference-input" accept="image/*" style="display: none;" />
          </div>
        </div>

        <div class="presets-section">
          <span class="presets-title">–ò–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∏–ª—å:</span>
          <div class="presets-grid">
            <button class="preset-btn" data-prompt="–°–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è –∫–æ—Ä–æ—Ç–∫–∞—è —Å—Ç—Ä–∏–∂–∫–∞ –±–æ–±">–ë–æ–±</button>
            <button class="preset-btn" data-prompt="–î–ª–∏–Ω–Ω—ã–µ –≤–æ–ª–Ω–∏—Å—Ç—ã–µ –≤–æ–ª–æ—Å—ã">–í–æ–ª–Ω—ã</button>
            <button class="preset-btn" data-prompt="Pixie cut –∫–æ—Ä–æ—Ç–∫–∞—è —Å—Ç—Ä–∏–∂–∫–∞">–ü–∏–∫—Å–∏</button>
            <button class="preset-btn" data-prompt="–ö–∞—Ä–µ —Å —á–µ–ª–∫–æ–π">–ö–∞—Ä–µ</button>
            <button class="preset-btn" data-prompt="–ê—Ñ—Ä–æ –∫—É–¥—Ä–∏">–ê—Ñ—Ä–æ</button>
            <button class="preset-btn" data-prompt="–ö–æ—Å–∞ —Ä—É—Å–∞–ª–∫–∏">–ö–æ—Å–∞</button>
          </div>
        </div>

        <div class="prompt-section">
          <label class="prompt-label" for="prompt-input">3Ô∏è‚É£ –û–ø–∏—à–∏—Ç–µ –∂–µ–ª–∞–µ–º—É—é –ø—Ä–∏—á–µ—Å–∫—É:</label>
          <textarea 
            id="prompt-input" 
            placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –î–ª–∏–Ω–Ω—ã–µ –∫–∞—à—Ç–∞–Ω–æ–≤—ã–µ –≤–æ–ª–æ—Å—ã —Å –ª–µ–≥–∫–∏–º–∏ –≤–æ–ª–Ω–∞–º–∏ –∏ —Å–≤–µ—Ç–ª—ã–º–∏ –ø—Ä—è–¥—è–º–∏..."
          ></textarea>
        </div>

        <div class="controls-top-row">
          <div class="credits-counter">
            –ö—Ä–µ–¥–∏—Ç–æ–≤: <span id="credits-display">10</span>
          </div>
        </div>

        <div class="buttons-container">
          <button class="btn-generate" id="generate-btn" disabled>
            üé® –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ–±—Ä–∞–∑
          </button>
          <button class="btn-reset" id="reset-btn">üîÑ –°–±—Ä–æ—Å</button>
        </div>

        <div class="history-section">
          <h2 class="history-title">üìö –ò—Å—Ç–æ—Ä–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–π</h2>
          <div class="history-gallery" id="history-gallery">
            <p style="color: #666; text-align: center;">–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞. –°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—É—é –≥–µ–Ω–µ—Ä–∞—Ü–∏—é!</p>
          </div>
        </div>
      </div>
    </div>

    <script >
      // Telegram WebApp –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
      const tg = window.Telegram?.WebApp;
      if (tg) {
        tg.ready();
        tg.expand();
        }

      // –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
      let selfieData = null;
      let referenceData = null;
      let credits = 10;
      let history = [];

      // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
      const selfieUpload = document.getElementById('selfie-upload');
      const selfieInput = document.getElementById('selfie-input');
      const referenceUpload = document.getElementById('reference-upload');
      const referenceInput = document.getElementById('reference-input');
      const promptInput = document.getElementById('prompt-input');
      const generateBtn = document.getElementById('generate-btn');
      const resetBtn = document.getElementById('reset-btn');
      const creditsDisplay = document.getElementById('credits-display');
      const errorContainer = document.getElementById('error-container');
      const historyGallery = document.getElementById('history-gallery');

      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤
      selfieUpload.addEventListener('click', () => selfieInput.click());
      referenceUpload.addEventListener('click', () => referenceInput.click());

      selfieInput.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (file) {
          selfieData = await fileToBase64(file);
          displayPreview(selfieUpload, selfieData);
          updateGenerateButton();
        }
      });

      referenceInput.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (file) {
          referenceData = await fileToBase64(file);
          displayPreview(referenceUpload, referenceData);
        }
      });

      // Preset –∫–Ω–æ–ø–∫–∏
      document.querySelectorAll('.preset-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          promptInput.value = btn.dataset.prompt;
        });
      });

      // –ö–Ω–æ–ø–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
      generateBtn.addEventListener('click', async () => {
        if (!selfieData) return;

        showLoading(true);
        clearError();

        try {
          const response = await fetch('/api/generate', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              userPhoto: selfieData,
              referencePhoto: referenceData,
              prompt: promptInput.value || '–°—Ç–∏–ª—å–Ω–∞—è —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è –ø—Ä–∏—á–µ—Å–∫–∞'
            })
          });

          const data = await response.json();

          if (!response.ok) {
            throw new Error(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏');
          }

          // –û–±–Ω–æ–≤–ª—è–µ–º –∫—Ä–µ–¥–∏—Ç—ã
          credits = data.creditsLeft;
          creditsDisplay.textContent = credits;

          // –î–æ–±–∞–≤–ª—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é
          addToHistory(data.image);

          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
          if (tg) {
            tg.showAlert('‚úÖ –ü—Ä–∏—á–µ—Å–∫–∞ —É—Å–ø–µ—à–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–∞!');
          }

        } catch (error) {
          showError(error.message);
        } finally {
          showLoading(false);
        }
      });

      // –ö–Ω–æ–ø–∫–∞ —Å–±—Ä–æ—Å–∞
      resetBtn.addEventListener('click', () => {
        selfieData = null;
        referenceData = null;
        promptInput.value = '';
        selfieUpload.innerHTML = '<span class="placeholder-text">üì∏ –ù–∞–∂–º–∏—Ç–µ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏</span>';
        selfieUpload.classList.remove('filled');
        referenceUpload.innerHTML = '<span class="placeholder-text">üñºÔ∏è –ó–∞–≥—Ä—É–∑–∏—Ç–µ –ø—Ä–∏–º–µ—Ä –ø—Ä–∏—á–µ—Å–∫–∏</span>';
        referenceUpload.classList.remove('filled');
        selfieInput.value = '';
        referenceInput.value = '';
        updateGenerateButton();
        clearError();
      });

      // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
      function fileToBase64(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
reader.onload = () => resolve((reader.result || '').split(',')[1] || reader.result);
          reader.onerror = reject;
          reader.readAsDataURL(file);
        });
      }

      function displayPreview(container, base64Data) {
        container.innerHTML = `<img src="data:image/jpeg;base64,${base64Data}" class="preview-image" alt="–ü—Ä–µ–≤—å—é" />`;
        container.classList.add('filled');
      }

      function updateGenerateButton() {
        generateBtn.disabled = !selfieData || credits <= 0;
        if (credits <= 0) {
          generateBtn.classList.add('no-credits');
          generateBtn.textContent = 'üí≥ –ü–æ–ø–æ–ª–Ω–∏—Ç—å –∫—Ä–µ–¥–∏—Ç—ã';
        } else {
          generateBtn.classList.remove('no-credits');
          generateBtn.textContent = 'üé® –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ–±—Ä–∞–∑';
        }
      }

      function showLoading(loading) {
        if (loading) {
          generateBtn.disabled = true;
          generateBtn.innerHTML = '<span class="loading-spinner"></span>–ì–µ–Ω–µ—Ä–∞—Ü–∏—è...';
        } else {
          updateGenerateButton();
        }
      }

      function showError(message) {
        errorContainer.innerHTML = `<div class="error-message">‚ùå ${message}</div>`).join('</div>`).join('');')).join('</div>`).join('</div>`).join('');')).join('');');
      }

      function clearError() {
        errorContainer.innerHTML = '';
      }

      function addToHistory(imageBase64) {
        history.unshift(imageBase64);
        if (history.length > 20) history.pop();
        renderHistory();
      }

      function renderHistory() {
        if (history.length === 0) {
          historyGallery.innerHTML = '<p style="color: #666; text-align: center;">–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞. –°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—É—é –≥–µ–Ω–µ—Ä–∞—Ü–∏—é!</p>';
          return;
        }

        historyGallery.innerHTML = history.map((img, index) => `<div class="history-item"><img src="data:image/jpeg;base64,${img}" alt="–ò—Å—Ç–æ—Ä–∏—è ${index + 1}" /></div>`).join('</div>`).join('');')).join('</div>`).join('</div>`).join('');')).join('');')
      }

      // –ó–∞–≥—Ä—É–∑–∫–∞ –∫—Ä–µ–¥–∏—Ç–æ–≤ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ
      async function loadCredits() {
        try {
          const response = await fetch('/api/credits');
          if (response.ok) {
            const data = await response.json();
            credits = data.credits;
            creditsDisplay.textContent = credits;
            updateGenerateButton();
          }
        } catch (error) {
          console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫—Ä–µ–¥–∏—Ç–æ–≤:', error);
        }
      }

      // –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ
      async function loadHistory() {
        try {
          const response = await fetch('/api/history');
          if (response.ok) {
            const data = await response.json();
            history = data.history || [];
            renderHistory();
          }
        } catch (error) {
          console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏:', error);
        }
      }

      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
      loadCredits();
      loadHistory();
    </script>
  </body>
</html>
